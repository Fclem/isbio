{% extends "base.html" %}

{% load bootstrap_toolkit %}

{% block title %}Jobs{% endblock %} 

{% block content %}
<div class="row-fluid">    
  <div class="span3">
    <table class="table table-bordered table-condensed">
      <tbody>
        <div id="dashboard">
        {% for job in current %}
          <tr id="{{ job.id }}_tr1" class="info"> <td>{{ job.jname }}  -  {{ job.staged }}</td> </tr>
          <tr id="{{ job.id }}_tr2" class="info"> 
              <td><div id="{{ job.id }}_div" class="progress progress-striped active"><div id="{{ job.id }}_bar" class="bar jbar" data-param="{{ job.id }}" style="width: {{ job.progress }}%" /></div></td> 
          </tr>
        {% empty %}
          <tr class="info"><td> <div align="center"> Nothing is running at the moment. </div> </td></tr>
        {% endfor %}
        
        </div>
        
        {% for job in dash_history %}
          {% if job.status == "succeed" %}
            <tr class="success"><td>{{ job.jname }}  -  {{ job.staged }}</td></tr>
            <tr class="success"><td><div class="progress progress-success"><div class="bar" style="width: 100%"/></div></td></tr>
          {% elif job.status == "failed" %}
            <tr class="error"><td>{{ job.jname }}  -  {{ job.staged }}</td></tr>
            <tr class="error"><td><div class="progress progress-danger"><div class="bar" style="width: {{ job.progress }}%" /></div></td></tr>
          {% elif job.status == "aborted" %}
            <tr class="error"><td>{{ job.jname }} - ABORTED!  -  {{ job.staged }}</td></tr>
            <tr class="error"><td><div class="progress progress-warning"><div class="bar" style="width: {{ job.progress }}%" /></div></td></tr>
          {% endif %}
          {% empty %}
            <tr class="info"><td> <div align="center"> You do not have job history yet. </div> </td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <div class="span9">

    <div class="tabbable">
      <!-- Tabs' Header --> 
      <ul class="nav nav-tabs" id="jobTabs">
        <li class="{{ scheduled_tab }}" ><a href="#scheduled" data-toggle="tab">Scheduled</a></li>
        <li class="{{ history_tab }}"><a href="#history" data-toggle="tab">History</a></li>
        <li class="{{ current_tab }}"><a href="#current" data-toggle="tab">In Progress</a></li>
      </ul>
      <!-- Tabs' Content --> 
      <div class="tab-content">
        <div class="tab-pane {{ show_sched }}" id="scheduled">
          <table class="table table-striped">
            <head>
              <tr>
                <th>Born</th>
                <th>Job Name</th>
                <th></th>
                <th></th>
                <th>Actions:</th>
                <th></th>
                <th></th>
                <th></th>
              </tr>
            </head>
            <tbody>
              {% for job in scheduled %}
              <tr>
                <td>{{ job.staged }}</td>
                <td>{{ job.jname }}</td>
                <td></td>
                <td></td>
                <td><a href="/jobs/run/{{ job.id }}" class="btn btn-inverse">Submit</a></td>
                <td><a href="#" data-toggle="modal" class="btn btn-info rtext" data-target="#script"  data-param={{ job.id }}><i class="icon-file"></i></a></td>
                <td><a href="#" data-toggle="modal" class="btn btn-info apply" data-target="#Apply"  data-param={{ job.id }}><i class="icon-edit"></i></a></td>
                <td><a href="/jobs/delete/{{ job.id }}" class="btn btn-info" ><i class="icon-remove"></i></a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="tab-pane {{ show_hist }}" id="history">
          <table class="table table-striped">
            <head>
              <tr>
                <th>Finished</th>
                <th>Job Name</th>
                <th></th>
                <th>Status</th>
                <th>Actions:</th>
                <th></th>
                <th></th>
                <th></th>
              </tr>
            </head>
            <tbody id="history_top">
              {% for job in history %}
              <tr>
                <td>{{ job.staged }}</td>
                <td>{{ job.jname }}</td>
                <td></td>
                <td>
                  {% if job.status == "succeed" %}
                    <span class="label label-success">{{ job.status.upper }}</span>
                  {% elif job.status == "failed" %}
                    <span class="label label-important">{{ job.status.upper }}</span>
                  {% elif job.status == "aborted" %}
                    <span class="label label-warning">{{ job.status.upper }}</span>
                  {% endif %}
                </td>
                <td><a class="btn btn-inverse" href="/jobs/download/{{ job.id }}"><i class="icon-download-alt"></i> Download Results</a></td>
                <td><a href="#" data-toggle="modal" class="btn btn-info rtext" data-target="#script"  data-param={{ job.id }}><i class="icon-file"></i></a></td>
                <td><a href="#" data-toggle="modal" class="btn btn-info apply" data-target="#Apply" data-param="{{ job.id }}-repl" ><i class="icon-repeat"></i></a></td>
                <td><a href="/jobs/delete/{{ job.id }}" class="btn btn-info" ><i class="icon-remove"></i></a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="tab-pane {{ show_curr }}" id="current">
          <table class="table table-striped">
            <head>
              <tr>
                <th>Triggered</th>
                <th>Job Name</th>
                <th>Progress</th>
                <th></th>
                <th></th>
                <th>Actions:</th>
                <th></th>
                <th></th>
                <th></th>
              </tr>
            </head>
            <tbody>
              {% for job in current %}
              <tr id="{{ job.id }}_list_tr">
                <td>{{ job.staged }}</td>
                <td>{{ job.jname }}</td>
                <td id="{{ job.id }}_list_td">{{ job.progress }} %</td>
                <td></td>
                <td></td>
                <td><a href="#" class="btn btn-danger">Abort</a></td>
                <td></td><td></td><td></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <!-- END of Tabs' Content -->
    </div>  

  </div>
</div>

<!-- Modals -->
<div id="script" class="modal fade" role="dialog"  aria-hidden="true"></div>
<div id="Apply" class="modal fade" role="dialog"  aria-hidden="true"></div>

<script>
    $(document).ready(function() {
        modalConnect();
        $(".jbar").each(function(){
            var par = $(this).data("param");
            updateJobs(par);        
        });
        
    });
    $(".rtext").click(function(ev) { 
        ev.preventDefault(); // prevent navigation
        var par = $(this).data("param"); 
        $("#script").load("/jobs/show-code/"+par, function() { 
            $(this).modal('show'); 
        });
        return false; // prevent the click propagation
    });  
</script>
<script type="text/javascript">
function submitItemModalFormBind(url){
         $('#form_modal_apply').submit(function(ev){
             var formData = new FormData($('form')[0]);
             $.ajax({                
                type: "POST",
                url: url,
                enctype: 'multipart/form-data',
                data: formData,
                success:function(response, textStatus, jqXHR){
                    var form = $("#form_modal_apply_div", response);
                    //form is returned if it is not valid. update modal with returned form
                    //change this "if" to check for a specific return code which should be set in the view
                    if (form.html()) {
                       //update modal div
                       
                        $('#form_modal_apply_div').html(form);
                        $("input:file").customFileInput({ });
                        $("#Apply").modal('show');
                    }
                    //form is not returned if form submission succeeded
                    else{                          
                        //update the entire document with the response received since we received a entire success page and we want to reload the entire page
                        document.open();
                        document.write(response);
                        document.close();
                        $("#Apply").modal('hide');
                    }
                }, 
                error: function (request, status, error) {
                            //implement proper error handling
                            console.log("failure");
                            console.log(request.responseText);
                    },
                cache: false,
                contentType: false,
                processData: false
                    });
                    return false;
                });
              }
function modalConnect()
        {
            $(".apply").unbind('click');
            //bind the click event
            $(".apply").click(function(ev) {
                ev.preventDefault(); // prevent navigation
                var par = $(this).data("param");
                $.get("/jobs/edit/"+par, function(results){
                  //update the dom with the received form
                  $('#Apply').html(results);
                  $("input:file").customFileInput({ });
                  $("#Apply").modal('show');
                  $(document).ready(function () {
                     //bind the form to an ajax call. ajax call will be set to the received update url
                     submitItemModalFormBind("/jobs/edit/"+par);
                  });

                }, "html");
                return false; // prevent the click propagation
            });
        }

function updateJobs(jid) {
    $.ajax({
        //data: "data",
        type: "GET",
        url: "/update-jobs/"+jid,
        dataType : 'json',
        success: function (msg) {
            //alert(msg.name)
            var arg = "width: " + msg.progress.toString() + "%";
            $("#" + jid.toString() + "_bar").attr('style', arg);
            $("#" + jid.toString() + "_list_td").text(msg.progress.toString() + "%");
            
            if (msg.status != "active") {
                var jstatus = ''
                var jbar = ''
                if (msg.status == "succeed") { jstatus = "success"; jbar = "success"; }
                if (msg.status == "failed") { jstatus = "error"; jbar = "danger"; }
                if (msg.status == "aborted") { jstatus = "error"; jbar = "warning"; }
                
                $("#" + jid.toString() + "_tr1").attr('class', jstatus);
                $("#" + jid.toString() + "_tr2").attr('class', jstatus);
                $("#" + jid.toString() + "_div").attr('class', "progress progress-" + jbar + " progress-striped active");
                $('#history_top').prepend(appendToHistory(msg));
                $("#" + jid.toString() + "_list_tr").remove();  
            }
            else {
                window.setTimeout(updateJobs, 300, jid);
            }
        }
    });
    }; 
function appendToHistory(job){
    var jstatus = ''
    if (job.status.toString() == "succeed") { jstatus = "success"; }
    else if (job.status.toString() == "failed") { jstatus = "important"; }
    else if (job.status.toString() == "aborted") { jstatus = "warning"; }
    
    var new_row = '<tr> <td>  NOW!</p></td> <td>' + job.name + '</td> <td></td>';
    new_row += '<td> <span class="label label-' + jstatus + '">' + job.status.toString().toUpperCase() + '</span> </td>'
    new_row += '<td><a class="btn btn-inverse" href="/jobs/download/' + job.id + '"><i class="icon-download-alt"></i> Download Results</a></td>'
    new_row += '<td><a href="#" data-toggle="modal" class="btn btn-info rtext" data-target="#script"  data-param=' + job.id + '><i class="icon-file"></i></a></td>'
    new_row += '<td><a href="#" data-toggle="modal" class="btn btn-info apply" data-target="#Apply" data-param="' + job.id + '-repl" ><i class="icon-repeat"></i></a></td>'
    new_row += '<td><a href="/jobs/delete/' + job.id + '" class="btn btn-info" ><i class="icon-remove"></i></a></td>  </tr>'
    return new_row;
} ;
</script>


{% endblock %}