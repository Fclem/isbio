<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>test</title>
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.6.2/fabric.min.js">
	</script>
	<!--
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.0.0.slim.min.js"></script>
	-->

	<script type="text/javascript">
		(function (funcName, baseObj) {
			// The public function name defaults to window.docReady
			// but you can pass in your own object and own function name and those will be used
			// if you want to put them in a different namespace
			funcName = funcName || "docReady";
			baseObj = baseObj || window;
			var readyList = [];
			var readyFired = false;
			var readyEventHandlersInstalled = false;

			// call this when the document is ready
			// this function protects itself against being called more than once
			function ready() {
				if (!readyFired) {
					// this must be set to true before we start calling callbacks
					readyFired = true;
					for (var i = 0; i < readyList.length; i++) {
						// if a callback here happens to add new ready handlers,
						// the docReady() function will see that it already fired
						// and will schedule the callback to run right after
						// this event loop finishes so all handlers will still execute
						// in order and no new ones will be added to the readyList
						// while we are processing the list
						readyList[i].fn.call(window, readyList[i].ctx);
					}
					// allow any closures held by these functions to free
					readyList = [];
				}
			}

			function readyStateChange() {
				if (document.readyState === "complete") {
					ready();
				}
			}

			// This is the one public interface
			// docReady(fn, context);
			// the context argument is optional - if present, it will be passed
			// as an argument to the callback
			baseObj[funcName] = function (callback, context) {
				// if ready has already fired, then just schedule the callback
				// to fire asynchronously, but right away
				if (readyFired) {
					setTimeout(function () {callback(context);}, 1);
					return;
				} else {
					// add the function and context to the list
					readyList.push({fn: callback, ctx: context});
				}
				// if document already ready to go, schedule the ready function to run
				if (document.readyState === "complete") {
					setTimeout(ready, 1);
				} else if (!readyEventHandlersInstalled) {
					// otherwise if we don't have event handlers installed, install them
					if (document.addEventListener) {
						// first choice is DOMContentLoaded event
						document.addEventListener("DOMContentLoaded", ready, false);
						// backup is window load event
						window.addEventListener("load", ready, false);
					} else {
						// must be IE
						document.attachEvent("onreadystatechange", readyStateChange);
						window.attachEvent("onload", ready);
					}
					readyEventHandlersInstalled = true;
				}
			}
		})("docReady", window);
	</script>
	<script type="text/javascript">
		var profile_url = 'http://127.0.0.1:8000/static/fb1.jpg';
		var flag_url = 'http://127.0.0.1:8000/static/uk.png';
		var img3id = 'img_can3';
		var flag_id = 'img_src1';
		var profile_id = 'img_src2';
		var init_opacity = 0.4;
	</script>
	<style type="text/css">
		#opacity-control{
			width: 1115px;
			vertical-align: middle;
		}
		p#controls{
			width: auto;
		}
	</style>
</head>

<body>
<p id="controls">
	<label><span>Opacity : <span id="opacity-control-label">#</span></span><br>
		0.2
		<input type="range" id="opacity-control" value="0" min="0.2" max="0.8" step="0.01">
		0.8
	</label>
</p>
<!--
<img id="img_src1"  src="http://127.0.0.1:8000/static/uk.png" style="display: none;">
<img id="img_src2" src="http://127.0.0.1:8000/static/fb1.jpg" style="display: none;">
-->
<canvas id="img_can3" width="1167" height="746"></canvas>
<p><a id="download" href="#">download</a></p>
<p><a id="reset" href="#">reset</a></p>

<script type="text/javascript">
	var org_h = 500;
	var org_w = 500;
	var target_h = 550;
	var target_w = 550;
	var profile_pic = null;
	var flag_pic = null;
	var canvas = null;
	canvas = new fabric.Canvas(img3id);

	function reset(fit_resize) {
		if (fit_resize === undefined || typeof fit_resize != Boolean) fit_resize = true;
		profile_pic = canvas.item(0);
		flag_pic = canvas.item(1);

		profile_pic.set({left: 0, top: 0, angle: 0, opacity: 1, selectable: 0});

		var target_h = profile_pic.height;
		var target_w = profile_pic.width;
		var factor = 1;

		flag_pic.set({width: org_w, height: org_h});
		console.debug(org_w + 'x' + org_h)

		// proportional resize to fill the image
		if (fit_resize) {
			// proportional resize to the lowest minimum common size, so that flag pic will fill the profile one
			if (target_h > target_w) {
				// picture is taller than wide
				factor = target_w / org_w;
				flag_pic.set({width: target_w, height: org_h * factor});
			} else if (target_w > target_h) {
				// picture is wider than tall
				factor = target_h / org_h;
				flag_pic.set({height: target_h, width: org_w * factor});
			}
		}
		// centering the flag picture
		if (flag_pic.height > target_h) {
			// vertical overflow
			flag_pic.set({left: 0, top: -(flag_pic.height - target_h) / 2});
		} else {
			// horizontal overflow
			flag_pic.set({left: -(flag_pic.width - target_w) / 2, top: 0});
		}
		opacityControl.value = init_opacity;
		update_opacity_value(opacityControl);
		flag_pic.set({angle: 0});

		canvas.renderAll();
	}
	
	function load_images(fit_resize) {
		//var profile_pic = null;
		//imgElement = document.getElementById(flag_id);
		//var profile_pic = new fabric.Image(imgElement);
		fabric.Image.fromURL(profile_url, function (profile_pic) {
			target_h = profile_pic.height;
			target_w = profile_pic.width;
			canvas.add(profile_pic);

			fabric.Image.fromURL(flag_url, function (flag_pic) {
				org_h = flag_pic.height;
				org_w = flag_pic.width;
				canvas.add(flag_pic);
				// call the reset function which sets the parameters
				reset(fit_resize);
			});
		});
		/*
		canvas.on('after:render', function () {

			canvas.forEachObject(function (obj) {
				console.debug(obj.width);
			})
		});
		*/
		/*
		fabric.Image.fromURL(profile_url, function (img) {
			canvas.add(img.set({left: 0, top: 0, angle: 0, opacity: 1, selectable: 0}));
			console.debug(img);
			profile_pic = img.i;
		}); */
		// var profile_pic = canvas.item(0);
		// var h = profile_pic.height;
		//var h = 120;
		// var w = profile_pic.width;
		//var w = 240;
		/*
		imgElement = document.getElementById(flag_id);
		var flag_pic = new fabric.Image(imgElement, {
			// width  : profile_pic.width,
			// height : profile_pic.height,
			left   : 0,
			top    : 0,
			angle  : 0,
			opacity: 0.40
		});
		canvas.add(flag_pic);
		*/
		return canvas;
	}

	function update_opacity_value(me) {
		img = canvas.item(1);
		//console.debug(canvas.item(1).opacity);
		if(img.opacity != me.value){
			$('opacity-control-label').innerHTML = parseFloat(me.value);
			img.setOpacity(parseFloat(me.value)).setCoords();
			canvas.renderAll();
		}
	}

	var $ = function (id) {return document.getElementById(id)};
	// adding control
	var opacityControl = $('opacity-control');
	opacityControl.onchange = function (){ update_opacity_value(this); };
	opacityControl.onmousemove = function (){ update_opacity_value(this); };
	opacityControl.value = init_opacity;

	var downloadBtn = $('download');
	downloadBtn.onclick = function () {
		img = canvas.item(1);
		img.set({hasControls: false, hasBorders: false});
		var data = canvas.toDataURL('png');
		// var path = "your file path will be here";
		var save = document.createElement('a');
		save.href = data;
		save.download = "MyProfilePicture.png";
		save.target = '_blank';
		var event = document.createEvent('Event');
		event.initEvent('click', true, true);
		save.dispatchEvent(event);
		(window.URL || window.webkitURL).revokeObjectURL(save.href);
		//location.href = data;
		img.set({hasControls: true, hasBorders: true});
	};

	var resetBtn = $('reset');
	resetBtn.onclick = function () {
		can = reset();
	};
	/*
	can = docReady(function () {
		return load_images();
	});
	*/
	can = load_images();
</script>

</body>

</html>
